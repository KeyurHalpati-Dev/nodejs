name: Build and Deploy Backend to AWS EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: backend-app

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    # Create Dockerfile dynamically for Node.js backend
    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        # Use Node.js LTS version
        FROM node:20-alpine
        
        WORKDIR /app
        
        # Copy package files
        COPY package*.json ./
        
        # Install dependencies
        RUN npm ci
        
        # Copy application files
        COPY . .
        
        # Create a non-root user for security
        RUN addgroup -g 1001 -S nodejs && \
            adduser -S nodejs -u 1001 && \
            chown -R nodejs:nodejs /app
        
        USER nodejs
        
        # Expose backend port
        EXPOSE 5000
        
        # Add healthcheck to monitor container health
        HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
          CMD node -e "require('http').get('http://localhost:5000/api/users', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" || exit 1
        
        # Start the application
        CMD ["npm", "start"]
        EOF
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest \
                     -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
    
    - name: Test Docker image
      run: |
        echo "üß™ Testing Docker image..."
        
        # Run container WITHOUT --rm flag so we can inspect logs even if it crashes
        docker run -d --name backend-service \
          -p 5000:5000 \
          -e NODE_ENV=test \
          -e PORT=5000 \
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
        echo "‚è≥ Waiting for container to start..."
        sleep 10
        
        # Check if container is still running
        if docker ps | grep -q backend-service; then
          echo "‚úÖ Container is running successfully!"
          
          # Test the API endpoint
          echo "üåê Testing API endpoint..."
          curl -f http://localhost:5000/api/users || echo "‚ö†Ô∏è  API endpoint not responding"
          
          echo "üìã Container logs:"
          docker logs backend-service
          
          docker stop backend-service
          docker rm backend-service
        else
          echo "‚ùå Container crashed on startup!"
          echo ""
          echo "üìã Container logs:"
          docker logs backend-service 2>&1 || echo "No logs available"
          echo ""
          echo "üîç Container inspect:"
          docker inspect backend-service --format='{{.State.Status}}: {{.State.Error}}' || true
          docker rm backend-service 2>/dev/null || true
          exit 1
        fi
    
    - name: Push Docker image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Image digest
      run: echo "Backend image pushed successfully!"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    
    steps:
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "üöÄ Starting backend deployment on AWS EC2..."
          
          # Login to Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # Pull the latest image
          echo "üì¶ Pulling latest Docker image..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Stop and remove old container if exists
          echo "üõë Stopping old container..."
          docker stop backend-app 2>/dev/null || true
          docker rm backend-app 2>/dev/null || true
          
          # Remove ALL containers using port 5000 (force cleanup)
          echo "üîç Checking for any containers on port 5000..."
          docker ps -a --format "{{.ID}} {{.Ports}}" | grep "5000" | awk '{print $1}' | xargs -r docker stop 2>/dev/null || true
          docker ps -a --format "{{.ID}} {{.Ports}}" | grep "5000" | awk '{print $1}' | xargs -r docker rm -f 2>/dev/null || true
          
          # Kill any process using port 5000
          echo "üîç Checking for processes on port 5000..."
          PID=$(ss -tlnp 2>/dev/null | grep ":5000" | awk '{print $6}' | sed 's/.*pid=//;s/,.*//' | head -1)
          if [ ! -z "$PID" ]; then
            echo "‚ö†Ô∏è  Found process $PID using port 5000, killing it..."
            kill -9 $PID 2>/dev/null || true
            sleep 2
          fi
          
          # Double check with fuser as backup
          if command -v fuser >/dev/null 2>&1; then
            fuser -k 5000/tcp 2>/dev/null || true
            sleep 1
          fi
          
          # Create Docker network if it doesn't exist
          echo "üåê Setting up Docker network..."
          docker network create my-app-network 2>/dev/null || echo "Network already exists"
          
          # Run new container with proper environment variables
          echo "‚ñ∂Ô∏è  Starting new container..."
          docker run -d \
            --name backend-app \
            --network my-app-network \
            -p 5000:5000 \
            --restart unless-stopped \
            -e NODE_ENV=production \
            -e PORT=5000 \
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Wait for container to start
          echo "‚è≥ Waiting for container to initialize..."
          sleep 8
          
          # Check if container is running
          if docker ps | grep -q backend-app; then
            echo "‚úÖ Container is running successfully!"
            docker ps | grep backend-app
          else
            echo "‚ùå Container failed to start!"
            echo "Container logs:"
            docker logs backend-app
            exit 1
          fi
          
          # Wait a bit more for the app to fully start
          sleep 5
          
          # Test the API endpoint
          echo "üåê Testing API endpoint..."
          if curl -f http://localhost:5000/api/users 2>/dev/null; then
            echo "‚úÖ API is responding correctly!"
          else
            echo "‚ö†Ô∏è  Warning: API endpoint not responding yet (may need more time to start)"
          fi
          
          # Clean up old Docker images (keep last 3)
          echo "üßπ Cleaning up old images..."
          docker images | grep "${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}" | tail -n +4 | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
          
          # Show container status
          echo "üìä Current container status:"
          docker ps -a | grep backend-app
          
          echo "üéâ Backend deployment completed successfully!"
    
    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "üîç Verifying backend deployment..."
          
          # Wait a bit more for full startup
          sleep 3
          
          # Check container logs (last 50 lines)
          echo "üìã Container logs:"
          docker logs --tail 50 backend-app
          
          # Check container health
          echo "üè• Container health check:"
          HEALTH_STATUS=$(docker inspect backend-app --format='{{.State.Health.Status}}' 2>/dev/null || echo "no healthcheck")
          echo "Health Status: $HEALTH_STATUS"
          docker inspect backend-app --format='{{.State.Status}}'
          
          # Test if app is responding
          echo "üåê Testing application response..."
          if curl -f -s http://localhost:5000/api/users > /dev/null 2>&1; then
            echo "‚úÖ Backend API is responding correctly!"
            echo "Sample response:"
            curl -s http://localhost:5000/api/users | head -n 20
          else
            echo "‚ö†Ô∏è  Warning: Application not responding on port 5000"
            echo "This might be normal if the app is still starting up."
          fi
          
          # Check if backend can be reached from within Docker network
          echo "üîó Testing network connectivity..."
          docker network inspect my-app-network | grep -A 10 "backend-app" || echo "Container not fully connected to network yet"
          
          echo "‚úÖ Verification complete!"
    
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "üéâ ‚úÖ Backend deployment successful!"
          echo "Your backend is now running at http://${{ secrets.EC2_HOST }}:5000"
          echo "API endpoint: http://${{ secrets.EC2_HOST }}:5000/api/users"
          echo "Container name: backend-app (accessible within Docker network)"
        else
          echo "‚ùå Backend deployment failed!"
          echo "Check the logs above for more details."
        fi